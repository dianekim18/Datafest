---
title: "covid19"
authors: Diane Kim, Arielle Hutchinson, Priya Parkash
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-packages}
library(tidyverse)
library("dplyr")
library(stringr)
library(RCurl)
library(betareg)
```
```{r load-data}
date_of_study = "04-20-2020"

covid_hist = read.csv(text=getURL("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_daily_reports/03-30-2020.csv"))
covid_us_hist = subset(covid_hist, Country_Region == "US" & is.na(FIPS)==F)

covid = read.csv(text=getURL(paste0("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_daily_reports/",date_of_study,".csv")))
covid_us = subset(covid,Country_Region == "US" & is.na(FIPS)!=T)
covid_us = rbind(covid_us,subset(covid_us_hist, (!(FIPS %in% covid_us$FIPS))  & Confirmed == 0 & Deaths == 0 & is.na(FIPS)==F))

county_pm = read.csv(text=getURL("https://raw.githubusercontent.com/wxwx1993/PM_COVID/master/Data/county_pm25.csv"))

pm_ave <- read_csv("county_pm_ave.csv")

dem <- read_csv("co-est2019-alldata.csv")

census <- read_csv("census_county_interpolated.csv")

census_ave <- read_csv("census_ave.csv")


```

```{r clean-up-data}
county_pm %>%
  count(fips)

covid_us <- covid_us %>%
  mutate(fips = FIPS)

pm_mean = county_pm %>% 
  group_by(fips) %>% 
  summarise(pm25 = mean(pm25))
  
```

```{r deaths-proportion}
covid_us <- covid_us %>%
  group_by(fips) %>%
  mutate(deaths_prop = (1+Deaths)/Confirmed) %>%
  filter(deaths_prop<1 & !is.na(deaths_prop))

```

```{r}
fullset <- inner_join(covid_us, pm_mean, by = "fips")
ggplot(data = fullset, mapping = aes(x = deaths_prop))+
  geom_histogram()

full <- inner_join(fullset, census_ave, by = "fips")

ggplot(data = full, mapping = aes(x = poverty))+
  geom_histogram()

ggplot(data = full, mapping = aes(x = poverty, y = log(deaths_prop/(1-deaths_prop))))+
  geom_point()

model <- lm(deaths_prop ~ pm25, data = fullset)
tidy(model) %>%
  kable(format = "markdown", digits = 3)

census %>%
  count(fips)

county_pm %>%
  count(fips)

full <- inner_join(fullset, census_ave, by = "fips")
full <- full %>%
  mutate(Conf = Confirmed / population)

ggplot(data = full, mapping = aes(x = pct_asian, y = deaths_prop))+
  geom_point()

full_model <- betareg(deaths_prop ~ pm25 + poverty + pct_blk + medianhouseholdincome + medianhousevalue + hispanic + pct_native + pct_asian + pct_white + education + popdensity + poverty*pct_blk +poverty*pm25, data = full)
tidy(full_model) %>%
  kable(format = "markdown", digits = 6)



```

